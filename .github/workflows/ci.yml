name: Monorepo CI

on:
  push:
    branches: [ "**" ]
  pull_request:
    branches: [ "**" ]

permissions:
  contents: read
  packages: read

jobs:
  backend-tests:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 10.0.x

    - name: Setup Go
      uses: actions/setup-go@v5
      with:
        go-version: 1.23.x

    - name: List NuGet sources
      run: dotnet nuget list source

    - name: Authenticate to GitHub Packages
      run: |
        dotnet nuget add source \
          --username ${{ github.actor }} \
          --password ${{ secrets.NUGET_AUTH_TOKEN }} \
          --store-password-in-clear-text \
          --name github \
          "https://nuget.pkg.github.com/ressenzo/index.json"

    - name: Run tests for all backend projects
      run: |
        set -e

        echo "ðŸ” Scanning backend directory..."

        for dir in backend/*; do
          if [ -d "$dir" ]; then
            echo "âž¡ï¸ Processing $dir"

            # --------------------
            # .NET projects
            # --------------------
            if ls "$dir"/*.slnx 1> /dev/null 2>&1 || ls "$dir"/*.csproj 1> /dev/null 2>&1; then
              echo "ðŸŸ¦ Detected .NET project in $dir"

              COVERAGE_FILE="$dir/coverage/coverage.xml"
              mkdir -p "$dir/coverage"

              dotnet test "$dir" \
                --configuration Release \
                /p:CollectCoverage=true \
                /p:CoverletOutput="$COVERAGE_FILE" \
                /p:CoverletOutputFormat=cobertura \
                /p:Threshold=90 \
                /p:ThresholdType=line
                --logger "trx;LogFileName=$dir/coverage/TestResults.trx"

                echo "âœ… .NET project coverage report saved at $COVERAGE_FILE"
            fi

            # --------------------
            # Go projects
            # --------------------
            if [ -f "$dir/go.mod" ]; then
              echo "ðŸŸ© Detected Go project in $dir"

              cd "$dir"
              go test ./... -coverprofile=coverage.out -covermode=atomic

              COVERAGE=$(go tool cover -func=coverage.out | grep total | awk '{print substr($3, 1, length($3)-1)}')
              echo "Total coverage: $COVERAGE%"

              if (( $(echo "$COVERAGE < 90.0" | bc -l) )); then
                echo "âŒ Go coverage below 90% in $dir"
                exit 1
              fi

              cd - > /dev/null
            fi

          fi
        done
